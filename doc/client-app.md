# Defense Allies Client App ì„¤ê³„ ë¬¸ì„œ

## ğŸ“‹ ê°œìš”

Defense Alliesì˜ ì›¹ í´ë¼ì´ì–¸íŠ¸ëŠ” React + Next.js ê¸°ë°˜ì˜ í˜„ëŒ€ì ì¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ, ì‹¤ì‹œê°„ í˜‘ë ¥ íƒ€ì›Œ ë””íœìŠ¤ ê²Œì„ì„ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

### í•µì‹¬ í”„ë ˆì„ì›Œí¬
- **React 18+**: ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ UI ë¼ì´ë¸ŒëŸ¬ë¦¬
- **Next.js 14+**: í’€ìŠ¤íƒ React í”„ë ˆì„ì›Œí¬
  - App Router ì‚¬ìš© (ìµœì‹  ë¼ìš°íŒ… ì‹œìŠ¤í…œ)
  - Server-Side Rendering (SSR) for SEO & ì´ˆê¸° ë¡œë”© ìµœì í™”
  - Client-Side Rendering (CSR) for ê²Œì„ í”Œë ˆì´ ë¶€ë¶„
- **TypeScript**: ì •ì  íƒ€ì… ê²€ì‚¬ ë° ê°œë°œ ìƒì‚°ì„± í–¥ìƒ

### ìŠ¤íƒ€ì¼ë§
- **Tailwind CSS**: ìœ í‹¸ë¦¬í‹° í¼ìŠ¤íŠ¸ CSS í”„ë ˆì„ì›Œí¬
  - ë¹ ë¥¸ ê°œë°œ ì†ë„
  - ì¼ê´€ëœ ë””ìì¸ ì‹œìŠ¤í…œ
  - ë°˜ì‘í˜• ë””ìì¸ ì§€ì›
- **CSS Modules**: ì»´í¬ë„ŒíŠ¸ë³„ ìŠ¤íƒ€ì¼ ê²©ë¦¬
  - ê²Œì„ UI ì»´í¬ë„ŒíŠ¸ì˜ ë³µì¡í•œ ìŠ¤íƒ€ì¼ë§
  - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¶©ëŒ ë°©ì§€

### ìƒíƒœ ê´€ë¦¬
- **Zustand**: ê²½ëŸ‰ ìƒíƒœ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
  - Reduxë³´ë‹¤ ê°„ë‹¨í•œ API
  - TypeScript ì¹œí™”ì 
  - ê²Œì„ ìƒíƒœ ê´€ë¦¬ì— ìµœì í™”
- **TanStack Query (React Query)**: ì„œë²„ ìƒíƒœ ê´€ë¦¬
  - API ìºì‹± ë° ë™ê¸°í™”
  - ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
  - ì˜¤í”„ë¼ì¸ ì§€ì›

### ì‹¤ì‹œê°„ í†µì‹ 
- **REST API**: ì¸ì¦ ê´€ë ¨ HTTP í†µì‹ 
- **JSON RPC**: ê²Œì„ ì„œë²„ API í†µì‹  (HTTP POST ê¸°ë°˜)
- **Server-Sent Events (SSE)**: ì„œë²„â†’í´ë¼ì´ì–¸íŠ¸ ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°

### ë¹Œë“œ ì‹œìŠ¤í…œ
- **Turbopack**: Next.js 14+ì˜ ìƒˆë¡œìš´ ë²ˆë“¤ëŸ¬
  - Webpack ëŒ€ë¹„ ìµœëŒ€ 10ë°° ë¹ ë¥¸ ë¹Œë“œ
  - ì¦ë¶„ ë¹Œë“œ ì§€ì›
  - ê°œë°œ ì„œë²„ Hot Reload ìµœì í™”

### í…ŒìŠ¤íŒ…
- **Jest**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬
- **React Testing Library**: React ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸
- **Playwright**: E2E í…ŒìŠ¤íŠ¸
  - í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸
  - ê²Œì„ í”Œë¡œìš° ìë™í™” í…ŒìŠ¤íŠ¸
- **MSW (Mock Service Worker)**: API ëª¨í‚¹

### ê²Œì„ ë Œë”ë§
- **React Three Fiber**: Reactìš© Three.js ë Œë”ëŸ¬
- **@react-three/drei**: R3F ìœ í‹¸ë¦¬í‹° ë¼ì´ë¸ŒëŸ¬ë¦¬
- **@react-three/postprocessing**: í¬ìŠ¤íŠ¸ í”„ë¡œì„¸ì‹± íš¨ê³¼
- **@react-spring/three**: 3D ì• ë‹ˆë©”ì´ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬
- **Three.js**: WebGL 3D ë¼ì´ë¸ŒëŸ¬ë¦¬

### ê°œë°œ ë„êµ¬
- **ESLint + Prettier**: ì½”ë“œ í’ˆì§ˆ ë° í¬ë§·íŒ…
- **Husky + lint-staged**: Git í›… ê´€ë¦¬
- **Storybook**: ì»´í¬ë„ŒíŠ¸ ë¬¸ì„œí™” ë° ê°œë°œ

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ì„¤ê³„

### ë Œë”ë§ ì „ëµ

```mermaid
graph TB
    subgraph "SSR Pages"
        HOME[í™ˆí˜ì´ì§€]
        AUTH[ë¡œê·¸ì¸/íšŒì›ê°€ì…]
        LOBBY[ë¡œë¹„]
        PROFILE[í”„ë¡œí•„]
    end

    subgraph "CSR Pages"
        GAME[ê²Œì„ í”Œë ˆì´]
        REALTIME[ì‹¤ì‹œê°„ ë§¤ì¹­]
    end

    subgraph "Hybrid"
        LEADERBOARD[ë¦¬ë”ë³´ë“œ]
        STATS[í†µê³„]
    end

    HOME --> |ë¹ ë¥¸ ì´ˆê¸° ë¡œë”©| SSR
    GAME --> |ì‹¤ì‹œê°„ ë°˜ì‘ì„±| CSR
    LEADERBOARD --> |SEO + ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸| HYBRID
```

### í´ë” êµ¬ì¡°

```
client/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/                   # ì¸ì¦ ê´€ë ¨ í˜ì´ì§€ ê·¸ë£¹
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ register/
â”‚   â”œâ”€â”€ (game)/                   # ê²Œì„ ê´€ë ¨ í˜ì´ì§€ ê·¸ë£¹
â”‚   â”‚   â”œâ”€â”€ lobby/
â”‚   â”‚   â”œâ”€â”€ play/
â”‚   â”‚   â””â”€â”€ spectate/
â”‚   â”œâ”€â”€ api/                      # API Routes (Next.js)
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ proxy/                # ë°±ì—”ë“œ í”„ë¡ì‹œ
â”‚   â”œâ”€â”€ globals.css
â”‚   â”œâ”€â”€ layout.tsx                # ë£¨íŠ¸ ë ˆì´ì•„ì›ƒ
â”‚   â”œâ”€â”€ page.tsx                  # í™ˆí˜ì´ì§€
â”‚   â””â”€â”€ loading.tsx               # ë¡œë”© UI
â”œâ”€â”€ components/                   # ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ ui/                       # ê¸°ë³¸ UI ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”œâ”€â”€ Modal.tsx
â”‚   â”‚   â””â”€â”€ Input.tsx
â”‚   â”œâ”€â”€ game/                     # ê²Œì„ ê´€ë ¨ ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”œâ”€â”€ GameBoard/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ GameBoard.module.css
â”‚   â”‚   â”‚   â””â”€â”€ GameBoard.stories.tsx
â”‚   â”‚   â”œâ”€â”€ Tower/
â”‚   â”‚   â”œâ”€â”€ Enemy/
â”‚   â”‚   â””â”€â”€ GameUI/
â”‚   â”œâ”€â”€ lobby/                    # ë¡œë¹„ ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”œâ”€â”€ PlayerList/
â”‚   â”‚   â”œâ”€â”€ MatchMaking/
â”‚   â”‚   â””â”€â”€ RoomSettings/
â”‚   â””â”€â”€ layout/                   # ë ˆì´ì•„ì›ƒ ì»´í¬ë„ŒíŠ¸
â”‚       â”œâ”€â”€ Header/
â”‚       â”œâ”€â”€ Sidebar/
â”‚       â””â”€â”€ Footer/
â”œâ”€â”€ hooks/                        # ì»¤ìŠ¤í…€ í›…
â”‚   â”œâ”€â”€ useSSE.ts                 # Server-Sent Events í›…
â”‚   â”œâ”€â”€ useJsonRPC.ts             # JSON RPC í†µì‹  í›…
â”‚   â”œâ”€â”€ useGameState.ts           # ê²Œì„ ìƒíƒœ í›…
â”‚   â”œâ”€â”€ useAuth.ts                # ì¸ì¦ í›…
â”‚   â””â”€â”€ useLocalStorage.ts        # ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í›…
â”œâ”€â”€ lib/                          # ìœ í‹¸ë¦¬í‹° ë¼ì´ë¸ŒëŸ¬ë¦¬
â”‚   â”œâ”€â”€ api.ts                    # REST API í´ë¼ì´ì–¸íŠ¸
â”‚   â”œâ”€â”€ jsonrpc.ts                # JSON RPC í´ë¼ì´ì–¸íŠ¸
â”‚   â”œâ”€â”€ sse.ts                    # Server-Sent Events í´ë¼ì´ì–¸íŠ¸
â”‚   â”œâ”€â”€ auth.ts                   # ì¸ì¦ ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ game-engine.ts            # ê²Œì„ ì—”ì§„ ë¡œì§
â”‚   â””â”€â”€ utils.ts                  # ê³µí†µ ìœ í‹¸ë¦¬í‹°
â”œâ”€â”€ stores/                       # Zustand ìŠ¤í† ì–´
â”‚   â”œâ”€â”€ authStore.ts              # ì¸ì¦ ìƒíƒœ
â”‚   â”œâ”€â”€ gameStore.ts              # ê²Œì„ ìƒíƒœ
â”‚   â”œâ”€â”€ lobbyStore.ts             # ë¡œë¹„ ìƒíƒœ
â”‚   â””â”€â”€ uiStore.ts                # UI ìƒíƒœ
â”œâ”€â”€ types/                        # TypeScript íƒ€ì… ì •ì˜
â”‚   â”œâ”€â”€ api.ts                    # REST API íƒ€ì…
â”‚   â”œâ”€â”€ jsonrpc.ts                # JSON RPC íƒ€ì…
â”‚   â”œâ”€â”€ sse.ts                    # SSE ì´ë²¤íŠ¸ íƒ€ì…
â”‚   â”œâ”€â”€ game.ts                   # ê²Œì„ íƒ€ì…
â”‚   â””â”€â”€ player.ts                 # í”Œë ˆì´ì–´ íƒ€ì…
â”œâ”€â”€ styles/                       # ê¸€ë¡œë²Œ ìŠ¤íƒ€ì¼
â”‚   â”œâ”€â”€ globals.css
â”‚   â””â”€â”€ components.css
â”œâ”€â”€ public/                       # ì •ì  íŒŒì¼
â”‚   â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ sounds/
â”‚   â””â”€â”€ icons/
â”œâ”€â”€ __tests__/                    # í…ŒìŠ¤íŠ¸ íŒŒì¼
â”‚   â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ lib/
â”‚   â””â”€â”€ e2e/                      # Playwright E2E í…ŒìŠ¤íŠ¸
â”œâ”€â”€ .storybook/                   # Storybook ì„¤ì •
â”œâ”€â”€ next.config.js                # Next.js ì„¤ì •
â”œâ”€â”€ tailwind.config.js            # Tailwind CSS ì„¤ì •
â”œâ”€â”€ tsconfig.json                 # TypeScript ì„¤ì •
â”œâ”€â”€ jest.config.js                # Jest ì„¤ì •
â”œâ”€â”€ playwright.config.ts          # Playwright ì„¤ì •
â””â”€â”€ package.json
```

## ğŸ® ê²Œì„ ë Œë”ë§ ì•„í‚¤í…ì²˜

### React Three Fiber ê¸°ë°˜ 2D ê²Œì„ ë Œë”ë§

React Three Fiber(R3F)ë¥¼ ì‚¬ìš©í•˜ì—¬ 2D íƒ€ì›Œ ë””íœìŠ¤ ê²Œì„ì„ êµ¬í˜„í•©ë‹ˆë‹¤. 3D ì—”ì§„ì˜ ì„±ëŠ¥ê³¼ ìœ ì—°ì„±ì„ í™œìš©í•˜ë©´ì„œë„ ê°„ë‹¨í•œ 2D ê¸°í•˜í•™ì  ë„í˜•ìœ¼ë¡œ ê²Œì„ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

#### 1. **React Three Fiber + 2D Sprites** (ê¶Œì¥ ë°©ì‹)

```typescript
import { Canvas } from '@react-three/fiber';
import { OrthographicCamera } from '@react-three/drei';
import * as THREE from 'three';

// React Three Fiber ê¸°ë°˜ ê²Œì„ ë³´ë“œ
interface GameBoardProps {
  gameState: GameState;
  onTowerPlace: (position: Position, towerType: TowerType) => void;
}

const GameBoard: React.FC<GameBoardProps> = ({ gameState, onTowerPlace }) => {
  return (
    <div className="game-container" style={{ width: '800px', height: '600px' }}>
      <Canvas>
        {/* 2D ë·°ë¥¼ ìœ„í•œ ì§êµ ì¹´ë©”ë¼ */}
        <OrthographicCamera
          makeDefault
          position={[0, 0, 10]}
          zoom={1}
          left={-400}
          right={400}
          top={300}
          bottom={-300}
        />

        {/* ì¡°ëª… */}
        <ambientLight intensity={0.8} />
        <directionalLight position={[10, 10, 5]} intensity={0.5} />

        {/* ê²Œì„ ìš”ì†Œë“¤ */}
        <GameScene
          gameState={gameState}
          onTowerPlace={onTowerPlace}
        />
      </Canvas>
    </div>
  );
};

// ê²Œì„ ì”¬ ì»´í¬ë„ŒíŠ¸
const GameScene: React.FC<{ gameState: GameState; onTowerPlace: Function }> = ({
  gameState,
  onTowerPlace
}) => {
  return (
    <group>
      {/* ë§µ ë°°ê²½ (í‰ë©´) */}
      <MapBackground />

      {/* ê²½ë¡œ */}
      <GamePath points={gameState.path} />

      {/* íƒ€ì›Œë“¤ */}
      {gameState.towers.map(tower => (
        <Tower3D
          key={tower.id}
          tower={tower}
          onClick={() => onTowerPlace(tower.position, tower.type)}
        />
      ))}

      {/* ì ë“¤ */}
      {gameState.enemies.map(enemy => (
        <Enemy3D
          key={enemy.id}
          enemy={enemy}
        />
      ))}

      {/* íˆ¬ì‚¬ì²´ë“¤ */}
      {gameState.projectiles.map(projectile => (
        <Projectile3D
          key={projectile.id}
          projectile={projectile}
        />
      ))}
    </group>
  );
};

// 2D ìŠ¤íƒ€ì¼ íƒ€ì›Œ ì»´í¬ë„ŒíŠ¸ (3D ê³µê°„ì—ì„œ í‰ë©´ìœ¼ë¡œ)
const Tower3D: React.FC<{ tower: TowerData; onClick: () => void }> = ({
  tower,
  onClick
}) => {
  const meshRef = useRef<THREE.Mesh>(null);

  return (
    <group position={[tower.x, tower.y, 0]}>
      {/* íƒ€ì›Œ ì‚¬ê±°ë¦¬ í‘œì‹œ (ì›í˜• í‰ë©´) */}
      <mesh rotation={[-Math.PI / 2, 0, 0]} position={[0, 0, -0.1]}>
        <ringGeometry args={[tower.range - 2, tower.range, 32]} />
        <meshBasicMaterial
          color="green"
          transparent
          opacity={0.2}
        />
      </mesh>

      {/* íƒ€ì›Œ ë³¸ì²´ (ì •ì‚¬ê°í˜• í‰ë©´) */}
      <mesh
        ref={meshRef}
        onClick={onClick}
        position={[0, 0, 0]}
      >
        <planeGeometry args={[40, 40]} />
        <meshBasicMaterial color={tower.color} />
      </mesh>

      {/* íƒ€ì›Œ ë ˆë²¨ í…ìŠ¤íŠ¸ (Sprite ì‚¬ìš©) */}
      <TowerLevelText level={tower.level} />
    </group>
  );
};

// 2D ìŠ¤íƒ€ì¼ ì  ì»´í¬ë„ŒíŠ¸
const Enemy3D: React.FC<{ enemy: EnemyData }> = ({ enemy }) => {
  const meshRef = useRef<THREE.Mesh>(null);

  // ì  ì´ë™ ì• ë‹ˆë©”ì´ì…˜
  useFrame(() => {
    if (meshRef.current) {
      meshRef.current.position.x = enemy.x;
      meshRef.current.position.y = enemy.y;
    }
  });

  return (
    <group>
      {/* ì  ë³¸ì²´ (ì›í˜• í‰ë©´) */}
      <mesh ref={meshRef} position={[enemy.x, enemy.y, 0]}>
        <circleGeometry args={[16, 16]} />
        <meshBasicMaterial color={enemy.color} />
      </mesh>

      {/* ì²´ë ¥ë°” */}
      <HealthBar
        position={[enemy.x, enemy.y + 25, 0]}
        health={enemy.health}
        maxHealth={enemy.maxHealth}
      />
    </group>
  );
};

// íˆ¬ì‚¬ì²´ ì»´í¬ë„ŒíŠ¸
const Projectile3D: React.FC<{ projectile: ProjectileData }> = ({ projectile }) => {
  return (
    <mesh position={[projectile.x, projectile.y, 0]}>
      <sphereGeometry args={[4, 8, 8]} />
      <meshBasicMaterial color="yellow" />
    </mesh>
  );
};

// ë§µ ë°°ê²½
const MapBackground: React.FC = () => {
  return (
    <mesh rotation={[-Math.PI / 2, 0, 0]} position={[0, 0, -1]}>
      <planeGeometry args={[800, 600]} />
      <meshBasicMaterial color="#2d5a27" />
    </mesh>
  );
};

// ê²Œì„ ê²½ë¡œ
const GamePath: React.FC<{ points: Position[] }> = ({ points }) => {
  const pathGeometry = useMemo(() => {
    const curve = new THREE.CatmullRomCurve3(
      points.map(p => new THREE.Vector3(p.x, p.y, 0))
    );
    return new THREE.TubeGeometry(curve, 64, 20, 8, false);
  }, [points]);

  return (
    <mesh geometry={pathGeometry} position={[0, 0, -0.5]}>
      <meshBasicMaterial color="#8B4513" />
    </mesh>
  );
};

// ì²´ë ¥ë°” ì»´í¬ë„ŒíŠ¸
const HealthBar: React.FC<{
  position: [number, number, number];
  health: number;
  maxHealth: number;
}> = ({ position, health, maxHealth }) => {
  const healthPercent = health / maxHealth;

  return (
    <group position={position}>
      {/* ë°°ê²½ */}
      <mesh>
        <planeGeometry args={[30, 4]} />
        <meshBasicMaterial color="red" />
      </mesh>
      {/* ì²´ë ¥ */}
      <mesh position={[-(30 * (1 - healthPercent)) / 2, 0, 0.01]}>
        <planeGeometry args={[30 * healthPercent, 4]} />
        <meshBasicMaterial color="green" />
      </mesh>
    </group>
  );
};
```

#### 2. **React Three Fiber + ì• ë‹ˆë©”ì´ì…˜** (ê³ ê¸‰ íš¨ê³¼)

```typescript
import { useSpring, animated } from '@react-spring/three';
import { useFrame } from '@react-three/fiber';

// ì• ë‹ˆë©”ì´ì…˜ì´ ì ìš©ëœ íƒ€ì›Œ ì»´í¬ë„ŒíŠ¸
const AnimatedTower: React.FC<{ tower: TowerData }> = ({ tower }) => {
  const [hovered, setHovered] = useState(false);

  // ìŠ¤í”„ë§ ì• ë‹ˆë©”ì´ì…˜
  const { scale, color } = useSpring({
    scale: hovered ? 1.2 : 1,
    color: hovered ? '#ff6b6b' : tower.color,
    config: { tension: 300, friction: 10 }
  });

  return (
    <animated.group
      position={[tower.x, tower.y, 0]}
      scale={scale}
      onPointerEnter={() => setHovered(true)}
      onPointerLeave={() => setHovered(false)}
    >
      <animated.mesh>
        <boxGeometry args={[40, 40, 10]} />
        <animated.meshBasicMaterial color={color} />
      </animated.mesh>
    </animated.group>
  );
};

// íŒŒí‹°í´ ì‹œìŠ¤í…œì„ í™œìš©í•œ í­ë°œ íš¨ê³¼
const ExplosionEffect: React.FC<{ position: Position }> = ({ position }) => {
  const particlesRef = useRef<THREE.Points>(null);
  const [particles] = useState(() => {
    const positions = new Float32Array(100 * 3);
    const velocities = new Float32Array(100 * 3);

    for (let i = 0; i < 100; i++) {
      positions[i * 3] = position.x;
      positions[i * 3 + 1] = position.y;
      positions[i * 3 + 2] = 0;

      velocities[i * 3] = (Math.random() - 0.5) * 10;
      velocities[i * 3 + 1] = (Math.random() - 0.5) * 10;
      velocities[i * 3 + 2] = Math.random() * 5;
    }

    return { positions, velocities };
  });

  useFrame(() => {
    if (particlesRef.current) {
      const positions = particlesRef.current.geometry.attributes.position.array as Float32Array;

      for (let i = 0; i < 100; i++) {
        positions[i * 3] += particles.velocities[i * 3] * 0.1;
        positions[i * 3 + 1] += particles.velocities[i * 3 + 1] * 0.1;
        positions[i * 3 + 2] += particles.velocities[i * 3 + 2] * 0.1;
      }

      particlesRef.current.geometry.attributes.position.needsUpdate = true;
    }
  });

  return (
    <points ref={particlesRef}>
      <bufferGeometry>
        <bufferAttribute
          attach="attributes-position"
          count={100}
          array={particles.positions}
          itemSize={3}
        />
      </bufferGeometry>
      <pointsMaterial color="orange" size={2} />
    </points>
  );
};
```

#### 3. **React Three Fiber + ì¸ìŠ¤í„´ì‹±** (ëŒ€ëŸ‰ ê°ì²´ ìµœì í™”)

```typescript
import { InstancedMesh } from '@react-three/drei';

// ëŒ€ëŸ‰ì˜ ì ì„ íš¨ìœ¨ì ìœ¼ë¡œ ë Œë”ë§
const EnemyInstances: React.FC<{ enemies: EnemyData[] }> = ({ enemies }) => {
  const meshRef = useRef<THREE.InstancedMesh>(null);
  const tempObject = useMemo(() => new THREE.Object3D(), []);

  useFrame(() => {
    if (!meshRef.current) return;

    enemies.forEach((enemy, index) => {
      tempObject.position.set(enemy.x, enemy.y, 0);
      tempObject.scale.setScalar(enemy.size);
      tempObject.updateMatrix();

      meshRef.current!.setMatrixAt(index, tempObject.matrix);
      meshRef.current!.setColorAt(index, new THREE.Color(enemy.color));
    });

    meshRef.current.instanceMatrix.needsUpdate = true;
    if (meshRef.current.instanceColor) {
      meshRef.current.instanceColor.needsUpdate = true;
    }
  });

  return (
    <instancedMesh ref={meshRef} args={[undefined, undefined, enemies.length]}>
      <circleGeometry args={[16, 16]} />
      <meshBasicMaterial />
    </instancedMesh>
  );
};
```

#### 4. **React Three Fiber + í¬ìŠ¤íŠ¸ í”„ë¡œì„¸ì‹±** (ì‹œê° íš¨ê³¼)

```typescript
import { EffectComposer, Bloom, Noise } from '@react-three/postprocessing';

const GameBoardWithEffects: React.FC = () => {
  return (
    <Canvas>
      <OrthographicCamera makeDefault position={[0, 0, 10]} />

      {/* ê²Œì„ ì”¬ */}
      <GameScene />

      {/* í¬ìŠ¤íŠ¸ í”„ë¡œì„¸ì‹± íš¨ê³¼ */}
      <EffectComposer>
        <Bloom
          intensity={0.5}
          luminanceThreshold={0.9}
          luminanceSmoothing={0.025}
        />
        <Noise opacity={0.02} />
      </EffectComposer>
    </Canvas>
  );
};

// ê¸€ë¡œìš° íš¨ê³¼ê°€ ìˆëŠ” íƒ€ì›Œ
const GlowTower: React.FC<{ tower: TowerData }> = ({ tower }) => {
  return (
    <group position={[tower.x, tower.y, 0]}>
      {/* ë©”ì¸ íƒ€ì›Œ */}
      <mesh>
        <boxGeometry args={[40, 40, 10]} />
        <meshBasicMaterial color={tower.color} />
      </mesh>

      {/* ê¸€ë¡œìš° íš¨ê³¼ (ë°ì€ ìƒ‰ìƒìœ¼ë¡œ ë¸”ë£¸ íš¨ê³¼ íŠ¸ë¦¬ê±°) */}
      <mesh scale={1.2}>
        <boxGeometry args={[40, 40, 10]} />
        <meshBasicMaterial
          color={tower.isActive ? '#ffffff' : tower.color}
          transparent
          opacity={0.3}
        />
      </mesh>
    </group>
  );
};
```

### React Three Fiber ì„±ëŠ¥ ìµœì í™” ì „ëµ

1. **React.memo**: ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
2. **useMemo/useCallback**: ê³„ì‚° ë¹„ìš©ì´ í° ì—°ì‚° ë©”ëª¨ì´ì œì´ì…˜
3. **Three.js ìµœì í™”**:
   - **ì¸ìŠ¤í„´ì‹±**: ë™ì¼í•œ ì§€ì˜¤ë©”íŠ¸ë¦¬ì˜ ëŒ€ëŸ‰ ê°ì²´ ë Œë”ë§
   - **LOD (Level of Detail)**: ê±°ë¦¬ì— ë”°ë¥¸ ë””í…Œì¼ ì¡°ì ˆ
   - **Frustum Culling**: í™”ë©´ ë°– ê°ì²´ ë Œë”ë§ ì œì™¸
   - **Object Pooling**: ê°ì²´ ì¬ì‚¬ìš©ìœ¼ë¡œ GC ì••ë°• ê°ì†Œ
4. **ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…**: ê²Œì„ ëª¨ë“ˆ ì§€ì—° ë¡œë”©
5. **useFrame ìµœì í™”**: ë¶ˆí•„ìš”í•œ í”„ë ˆì„ ì—…ë°ì´íŠ¸ ë°©ì§€

```typescript
// ì„±ëŠ¥ ìµœì í™” ì˜ˆì‹œ
const OptimizedGameScene: React.FC = () => {
  // ê°ì²´ í’€ë§
  const enemyPool = useMemo(() => new Array(100).fill(null).map(() => ({
    mesh: new THREE.Mesh(),
    inUse: false
  })), []);

  // LOD ì‹œìŠ¤í…œ
  const TowerWithLOD: React.FC<{ tower: TowerData; distance: number }> = ({
    tower,
    distance
  }) => {
    const geometry = useMemo(() => {
      if (distance < 100) {
        return <cylinderGeometry args={[20, 20, 40, 16]} />; // ê³ í’ˆì§ˆ
      } else if (distance < 200) {
        return <cylinderGeometry args={[20, 20, 40, 8]} />; // ì¤‘í’ˆì§ˆ
      } else {
        return <boxGeometry args={[40, 40, 40]} />; // ì €í’ˆì§ˆ
      }
    }, [distance]);

    return (
      <mesh position={[tower.x, tower.y, 0]}>
        {geometry}
        <meshBasicMaterial color={tower.color} />
      </mesh>
    );
  };

  return <group>{/* ê²Œì„ ìš”ì†Œë“¤ */}</group>;
};
```

## ğŸ”„ ìƒíƒœ ê´€ë¦¬ ì„¤ê³„

### Zustand ìŠ¤í† ì–´ êµ¬ì¡°

```typescript
// ê²Œì„ ìƒíƒœ ìŠ¤í† ì–´
interface GameStore {
  // ìƒíƒœ
  gameState: GameState | null;
  isPlaying: boolean;
  selectedTower: TowerType | null;

  // ì•¡ì…˜
  setGameState: (state: GameState) => void;
  placeTower: (position: Position, type: TowerType) => void;
  selectTower: (type: TowerType) => void;

  // ë¹„ë™ê¸° ì•¡ì…˜
  joinGame: (gameId: string) => Promise<void>;
  leaveGame: () => Promise<void>;
}
```

### ì„œë²„ ìƒíƒœ ê´€ë¦¬ (TanStack Query + JSON RPC)

```typescript
// JSON RPC ê¸°ë°˜ ê²Œì„ API í›…
export const useGameState = (gameId: string) => {
  return useQuery({
    queryKey: ['game', gameId],
    queryFn: () => jsonRpcCall('game.getState', { gameId }),
    enabled: !!gameId,
    // SSEë¡œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë˜ë¯€ë¡œ í´ë§ ë¶ˆí•„ìš”
  });
};

export const usePlaceTower = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ gameId, position, towerType }) =>
      jsonRpcCall('game.placeTower', { gameId, position, towerType }),
    onSuccess: () => {
      // SSE ì´ë²¤íŠ¸ë¡œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ë¯€ë¡œ ì¦‰ì‹œ ë¬´íš¨í™”í•˜ì§€ ì•ŠìŒ
    },
  });
};

// REST API ê¸°ë°˜ ì¸ì¦ í›…
export const useLogin = () => {
  return useMutation({
    mutationFn: (credentials) => restApiCall('/api/auth/login', credentials),
    onSuccess: (data) => {
      // JWT í† í° ì €ì¥
      localStorage.setItem('token', data.token);
    },
  });
};
```

## ğŸ”„ í†µì‹  ì•„í‚¤í…ì²˜

### HTTP ê¸°ë°˜ í†µì‹  ì „ëµ

```mermaid
graph TB
    subgraph "í´ë¼ì´ì–¸íŠ¸"
        AUTH[ì¸ì¦ ì»´í¬ë„ŒíŠ¸]
        GAME[ê²Œì„ ì»´í¬ë„ŒíŠ¸]
        SSE_CLIENT[SSE í´ë¼ì´ì–¸íŠ¸]
    end

    subgraph "ì„œë²„"
        REST_API[REST API<br/>ì¸ì¦ ì„œë²„]
        JSON_RPC[JSON RPC<br/>ê²Œì„ ì„œë²„]
        SSE_SERVER[SSE ì—”ë“œí¬ì¸íŠ¸<br/>ì‹¤ì‹œê°„ ì´ë²¤íŠ¸]
    end

    AUTH -->|POST /api/auth/login| REST_API
    AUTH -->|POST /api/auth/register| REST_API

    GAME -->|POST /api/game/rpc<br/>method: game.placeTower| JSON_RPC
    GAME -->|POST /api/game/rpc<br/>method: game.joinMatch| JSON_RPC

    SSE_CLIENT -->|GET /api/events/subscribe| SSE_SERVER
    SSE_SERVER -->|ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼| SSE_CLIENT
```

### í†µì‹  ë°©ì‹ë³„ ì—­í• 

#### 1. REST API (ì¸ì¦ ê´€ë ¨)
```typescript
// ì¸ì¦ API ì˜ˆì‹œ
interface AuthAPI {
  login: (credentials: LoginCredentials) => Promise<AuthResponse>;
  register: (userData: RegisterData) => Promise<AuthResponse>;
  logout: () => Promise<void>;
  refreshToken: () => Promise<TokenResponse>;
}

// ì‚¬ìš© ì˜ˆì‹œ
const authApi = {
  login: async (credentials) => {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentials),
    });
    return response.json();
  },
};
```

#### 2. JSON RPC (ê²Œì„ ì„œë²„ API)
```typescript
// JSON RPC í´ë¼ì´ì–¸íŠ¸
interface JsonRpcRequest {
  jsonrpc: '2.0';
  method: string;
  params: any;
  id: string | number;
}

interface JsonRpcResponse {
  jsonrpc: '2.0';
  result?: any;
  error?: JsonRpcError;
  id: string | number;
}

// ê²Œì„ API ë©”ì„œë“œ
const gameRpcMethods = {
  'game.joinMatch': (params: { playerId: string }) => Promise<MatchInfo>,
  'game.placeTower': (params: { gameId: string, position: Position, towerType: TowerType }) => Promise<void>,
  'game.upgradeTower': (params: { gameId: string, towerId: string }) => Promise<void>,
  'game.getState': (params: { gameId: string }) => Promise<GameState>,
};

// JSON RPC í˜¸ì¶œ í•¨ìˆ˜
async function jsonRpcCall(method: string, params: any): Promise<any> {
  const request: JsonRpcRequest = {
    jsonrpc: '2.0',
    method,
    params,
    id: Date.now(),
  };

  const response = await fetch('/api/game/rpc', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${getToken()}`,
    },
    body: JSON.stringify(request),
  });

  const result: JsonRpcResponse = await response.json();

  if (result.error) {
    throw new Error(result.error.message);
  }

  return result.result;
}
```

#### 3. Server-Sent Events (ì‹¤ì‹œê°„ ì´ë²¤íŠ¸)
```typescript
// SSE ì´ë²¤íŠ¸ íƒ€ì…
interface SSEEvent {
  type: 'game.stateUpdate' | 'game.towerPlaced' | 'game.waveStarted' | 'match.playerJoined';
  data: any;
  timestamp: number;
}

// SSE í´ë¼ì´ì–¸íŠ¸
class SSEClient {
  private eventSource: EventSource | null = null;
  private listeners: Map<string, Function[]> = new Map();

  connect(gameId: string): void {
    this.eventSource = new EventSource(`/api/events/subscribe?gameId=${gameId}`, {
      headers: {
        'Authorization': `Bearer ${getToken()}`,
      },
    });

    this.eventSource.onmessage = (event) => {
      const sseEvent: SSEEvent = JSON.parse(event.data);
      this.handleEvent(sseEvent);
    };

    this.eventSource.onerror = (error) => {
      console.error('SSE connection error:', error);
      // ì¬ì—°ê²° ë¡œì§
      setTimeout(() => this.connect(gameId), 5000);
    };
  }

  private handleEvent(event: SSEEvent): void {
    const listeners = this.listeners.get(event.type) || [];
    listeners.forEach(listener => listener(event.data));
  }

  on(eventType: string, listener: Function): void {
    if (!this.listeners.has(eventType)) {
      this.listeners.set(eventType, []);
    }
    this.listeners.get(eventType)!.push(listener);
  }

  disconnect(): void {
    if (this.eventSource) {
      this.eventSource.close();
      this.eventSource = null;
    }
  }
}

// React í›…ìœ¼ë¡œ SSE ì‚¬ìš©
function useSSE(gameId: string) {
  const [sseClient] = useState(() => new SSEClient());

  useEffect(() => {
    if (gameId) {
      sseClient.connect(gameId);
    }

    return () => sseClient.disconnect();
  }, [gameId, sseClient]);

  const subscribe = useCallback((eventType: string, listener: Function) => {
    sseClient.on(eventType, listener);
  }, [sseClient]);

  return { subscribe };
}
```

### í†µì‹  ìµœì í™” ì „ëµ

1. **ìš”ì²­ ë°°ì¹­**: ì—¬ëŸ¬ JSON RPC í˜¸ì¶œì„ í•˜ë‚˜ì˜ ë°°ì¹˜ë¡œ ì²˜ë¦¬
2. **ìºì‹±**: TanStack Queryë¡œ API ì‘ë‹µ ìºì‹±
3. **ì¬ì—°ê²°**: SSE ì—°ê²° ëŠê¹€ ì‹œ ìë™ ì¬ì—°ê²°
4. **ì—ëŸ¬ ì²˜ë¦¬**: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„ ë¡œì§
5. **í† í° ê°±ì‹ **: JWT í† í° ë§Œë£Œ ì‹œ ìë™ ê°±ì‹ 

## ğŸ“± ë°˜ì‘í˜• ë””ìì¸

### ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ì „ëµ

```javascript
// tailwind.config.js
module.exports = {
  theme: {
    screens: {
      'mobile': '320px',
      'tablet': '768px',
      'desktop': '1024px',
      'wide': '1440px',
    },
  },
};
```

### ê²Œì„ UI ì ì‘í˜• ë ˆì´ì•„ì›ƒ

- **ëª¨ë°”ì¼**: ì„¸ë¡œ ëª¨ë“œ, í„°ì¹˜ ìµœì í™” UI
- **íƒœë¸”ë¦¿**: ê°€ë¡œ/ì„¸ë¡œ ëª¨ë“œ ì§€ì›, ì œìŠ¤ì²˜ ì¸í„°í˜ì´ìŠ¤
- **ë°ìŠ¤í¬í†±**: ë§ˆìš°ìŠ¤/í‚¤ë³´ë“œ ìµœì í™”, ë©€í‹° ëª¨ë‹ˆí„° ì§€ì›

## ğŸ” ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ

1. **API í† í° ê´€ë¦¬**: httpOnly ì¿ í‚¤ ì‚¬ìš©
2. **XSS ë°©ì§€**: Content Security Policy ì„¤ì •
3. **ê²Œì„ ì¹˜íŒ… ë°©ì§€**:
   - ì¤‘ìš”í•œ ê²Œì„ ë¡œì§ì€ ì„œë²„ì—ì„œ ê²€ì¦
   - í´ë¼ì´ì–¸íŠ¸ëŠ” UI ë Œë”ë§ë§Œ ë‹´ë‹¹
4. **Rate Limiting**: API í˜¸ì¶œ ì œí•œ

### Next.js ë³´ì•ˆ ì„¤ì •

```javascript
// next.config.js
module.exports = {
  experimental: {
    turbo: {
      rules: {
        '*.svg': {
          loaders: ['@svgr/webpack'],
          as: '*.js',
        },
      },
    },
  },
  headers: async () => [
    {
      source: '/(.*)',
      headers: [
        {
          key: 'X-Content-Type-Options',
          value: 'nosniff',
        },
        {
          key: 'X-Frame-Options',
          value: 'DENY',
        },
      ],
    },
  ],
};
```

## ğŸš€ ë°°í¬ ì „ëµ

### Vercel ë°°í¬ (ê¶Œì¥)

- **ìë™ ë°°í¬**: Git í‘¸ì‹œ ì‹œ ìë™ ë°°í¬
- **í”„ë¦¬ë·° ë°°í¬**: PRë³„ ë¯¸ë¦¬ë³´ê¸° í™˜ê²½
- **Edge Functions**: ê¸€ë¡œë²Œ CDN í™œìš©
- **Analytics**: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### í™˜ê²½ë³„ ì„¤ì •

```bash
# í™˜ê²½ ë³€ìˆ˜
NEXT_PUBLIC_API_URL=http://localhost:8080
NEXT_PUBLIC_WS_URL=ws://localhost:8080
NEXT_PUBLIC_ENVIRONMENT=development
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë¶„ì„

### ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

- **Core Web Vitals**: LCP, FID, CLS ì¶”ì 
- **ê²Œì„ ì„±ëŠ¥**: FPS, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
- **ì—ëŸ¬ ì¶”ì **: Sentry ì—°ë™

### ì‚¬ìš©ì ë¶„ì„

- **ê²Œì„ í”Œë ˆì´ ë¶„ì„**: í”Œë ˆì´ ì‹œê°„, ìŠ¹ë¥ , ì´íƒˆë¥ 
- **UI/UX ë¶„ì„**: í´ë¦­ íˆíŠ¸ë§µ, ì‚¬ìš©ì í”Œë¡œìš°

ì´ ë¬¸ì„œëŠ” Defense Allies í´ë¼ì´ì–¸íŠ¸ ì•±ì˜ ê¸°ìˆ ì  ê¸°ë°˜ì„ ì œê³µí•˜ë©°, ì‹¤ì œ êµ¬í˜„ ì‹œ ì„¸ë¶€ì‚¬í•­ì€ í”„ë¡œì íŠ¸ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì¡°ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
