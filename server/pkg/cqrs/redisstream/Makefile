# Redis Stream EventBus Makefile
# ê°œë°œ ë° í…ŒìŠ¤íŠ¸ í¸ì˜ì„±ì„ ìœ„í•œ Makefile

.PHONY: help test test-integration test-benchmark test-coverage redis-start redis-stop clean deps lint

# Default target
help: ## ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ í‘œì‹œ
	@echo "Redis Stream EventBus Development Commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Dependencies
deps: ## Go ì˜ì¡´ì„± ì„¤ì¹˜
	@echo "ğŸ“¦ Installing dependencies..."
	go mod download
	go mod tidy

# Redis management
redis-start: ## Redis ì»¨í…Œì´ë„ˆ ì‹œì‘
	@echo "ğŸš€ Starting Redis container..."
	docker run -d --name redis-eventbus -p 6379:6379 redis:7-alpine
	@echo "âœ… Redis started on localhost:6379"

redis-stop: ## Redis ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
	@echo "ğŸ›‘ Stopping Redis container..."
	-docker stop redis-eventbus
	-docker rm redis-eventbus
	@echo "âœ… Redis stopped and removed"

redis-restart: redis-stop redis-start ## Redis ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘

# Testing
test: ## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸ§ª Running unit tests..."
	go test -v -short ./pkg/cqrs/redisstream/...

test-integration: ## í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Redis í•„ìš”)
	@echo "ğŸ”— Running integration tests..."
	go test -v -tags=integration ./pkg/cqrs/redisstream/...

test-benchmark: ## ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸ“Š Running benchmark tests..."
	go test -bench=. -benchmem ./pkg/cqrs/redisstream/...

test-coverage: ## í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í™•ì¸
	@echo "ğŸ“ˆ Generating test coverage report..."
	go test -cover -coverprofile=coverage.out ./pkg/cqrs/redisstream/...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report generated: coverage.html"

test-all: test test-integration test-benchmark ## ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰

# Code quality
lint: ## ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
	@echo "ğŸ” Running linters..."
	go vet ./pkg/cqrs/redisstream/...
	go fmt ./pkg/cqrs/redisstream/...
	@echo "âœ… Linting complete"

# Examples
example-basic: ## ê¸°ë³¸ ì˜ˆì œ ì‹¤í–‰
	@echo "ğŸ¯ Running basic example..."
	cd pkg/cqrs/redisstream/example && go run main.go

example-advanced: ## ê³ ê¸‰ ê¸°ëŠ¥ ë°ëª¨ ì‹¤í–‰
	@echo "ğŸš€ Running advanced demo..."
	cd pkg/cqrs/redisstream/example && go run advanced_demo.go

# Development workflow
dev-setup: deps redis-start ## ê°œë°œ í™˜ê²½ ì´ˆê¸° ì„¤ì •
	@echo "ğŸ‰ Development environment ready!"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Run tests: make test"
	@echo "  2. Run examples: make example-basic"
	@echo "  3. Check coverage: make test-coverage"

dev-test: redis-start test redis-stop ## Redis ì‹œì‘ â†’ í…ŒìŠ¤íŠ¸ â†’ Redis ì¤‘ì§€

# CI/CD targets
ci-test: deps test test-integration ## CIìš© í…ŒìŠ¤íŠ¸ (Redis ì™¸ë¶€ ì‹¤í–‰ ê°€ì •)

# Cleanup
clean: ## ìƒì„±ëœ íŒŒì¼ ì •ë¦¬
	@echo "ğŸ§¹ Cleaning up..."
	-rm -f coverage.out coverage.html
	-docker stop redis-eventbus
	-docker rm redis-eventbus
	@echo "âœ… Cleanup complete"

# Performance monitoring
perf-profile: ## ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§ ì‹¤í–‰
	@echo "âš¡ Running performance profiling..."
	go test -cpuprofile=cpu.prof -memprofile=mem.prof -bench=BenchmarkEventBusPublishing ./pkg/cqrs/redisstream/
	@echo "ğŸ“Š Profile files generated: cpu.prof, mem.prof"
	@echo "View with: go tool pprof cpu.prof"

# Documentation
docs: ## ë¬¸ì„œ ìƒì„±
	@echo "ğŸ“š Generating documentation..."
	go doc -all ./pkg/cqrs/redisstream/ > docs.txt
	@echo "âœ… Documentation generated: docs.txt"

# Check system requirements
check-requirements: ## ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­ í™•ì¸
	@echo "ğŸ”§ Checking system requirements..."
	@echo -n "Go version: "
	@go version || echo "âŒ Go not installed"
	@echo -n "Docker version: "
	@docker --version || echo "âŒ Docker not installed"
	@echo -n "Redis connectivity: "
	@redis-cli ping 2>/dev/null || echo "âš ï¸  Redis not running (run 'make redis-start')"
	@echo "âœ… Requirements check complete"

# Full development cycle
full-cycle: clean dev-setup test-all test-coverage perf-profile ## ì „ì²´ ê°œë°œ ì‚¬ì´í´ ì‹¤í–‰
	@echo ""
	@echo "ğŸ‰ Full development cycle completed!"
	@echo "ğŸ“Š Coverage report: coverage.html"
	@echo "âš¡ Performance profiles: cpu.prof, mem.prof"

# Quick start for new developers
quickstart: ## ìƒˆë¡œìš´ ê°œë°œìë¥¼ ìœ„í•œ ë¹ ë¥¸ ì‹œì‘
	@echo "ğŸš€ QuickStart Guide for Redis Stream EventBus"
	@echo "============================================="
	@echo ""
	@echo "1. Install dependencies:"
	@echo "   make deps"
	@echo ""
	@echo "2. Start Redis:"
	@echo "   make redis-start"
	@echo ""
	@echo "3. Run tests:"
	@echo "   make test"
	@echo ""
	@echo "4. Try examples:"
	@echo "   make example-basic"
	@echo "   make example-advanced"
	@echo ""
	@echo "5. Check coverage:"
	@echo "   make test-coverage"
	@echo ""
	@echo "For full development setup: make dev-setup"
